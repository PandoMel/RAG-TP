# AGENTS.md
## Правила работы для Codex и разработчиков

Этот файл предназначен для того, чтобы Codex **не отклонялся от ТЗ**, не ломал безопасность и делал изменения предсказуемо.

---

## 1) Язык и стиль
- Язык общения, документации и комментариев: **русский**.
- Идентификаторы, имена модулей, API-роуты: латиница.
- Код: best practices, читаемо, без “магии”.
- В каждом модуле: короткие понятные комментарии, особенно в pipeline worker.

---

## 2) Архитектурные запреты и правила
- Парсинг/OCR/эмбеддинги/индексация выполняются **только в worker**.
- API не должен выполнять тяжелые операции.
- Postgres **не парсит** документы, он хранит текст/векторы/индексы.
- NAS всегда **read-only**. Запрещено добавлять запись на NAS.
- Пользователь не передает “сырой путь” к файлам. Любая выдача файлов — только по `document_id`.
- Path traversal защита обязательна для `view/download`.

---

## 3) Конфигурация
- **Все константы, лимиты, таймауты, параметры** — в `config.py`.
- По требованию проекта: NAS пароль/логин временно допускается в `config.py`.
- Нельзя логировать секреты (NAS_PASSWORD, ключи, токены).
- UI должен получать лимиты и whitelist через `GET /v1/config/public`.

---

## 4) Обязательные функции (v1)
- Вкладка 1 (default): “Поиск по файлу” (temp TTL).
- Вкладка 2: “Поиск по NAS” (sources + subpath фильтр).
- Hybrid search: BM25 (ParadeDB pg_search) + pgvector.
- Fusion: RRF по умолчанию (параметры из config).
- Reranker обязателен: сервис `/v1/rerank`.
- Источники в ответе обязательны (doc, path, page/sheet, snippet).
- Кнопки источников: “Открыть” (PDF inline) и “Скачать”.
- Подробные статусы: `jobs` + `job_steps`.
- **Очередь задач в UI**: левая колонка (позиция, имя файла, размер, статус/шаг).

---

## 5) Каскад обработки PDF (обязателен)
Реализовать каскад:
1) builtin text extraction
2) MinerU
3) PaddleOCR (по возможности выборочно по страницам)
Считать `quality_score` и пороги вынести в config.

Опционально: LLM-validation флагом (не обязательно включать по умолчанию).

GPU-lock обязателен (чтобы на GTX 1060 6GB не было параллельных GPU задач).

---

## 6) Админка
- `/admin` доступна только если `ADMIN_UI_ENABLED=true`.
- Управление `sources` + запуск incremental/full audit + просмотр jobs.

---

## 7) Логи
- Уровни: WARNING/ERROR/CRITICAL (INFO при DEBUG_LOGS).
- Формат: предпочтительно JSON.
- Не писать в логах секреты и большие куски текста документов.

---

## 8) Тестирование (минимум)
Добавить smoke-тесты:
- upload → job created → status reachable
- retrieval → возвращает citations
- view/download → не дает выйти за base_path (path traversal)
В тестах мокать OCR/reranker/LLM, чтобы они не требовали тяжелых моделей.

---

## 9) Запрещено менять без явного указания
- Не менять ключевые технологии (Postgres+pg_search+pgvector, BGE‑M3, PaddleOCR/MinerU, FastAPI, Redis/Celery).
- Не убирать очередь и job steps.
- Не упрощать безопасность.
- Не убирать источники/кнопки “Открыть/Скачать”.

---

## 10) План на будущее (фиксируем интерфейс, но не обязуем v1)
- Streaming `/v1/chat/stream` (SSE)
- Вкладка 3 “Распознать документ” (OCR+LLM, без индексации)
